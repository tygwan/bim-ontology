---
import Layout from '../layouts/Layout.astro';
const base = import.meta.env.BASE_URL;

// Code examples stored as strings to avoid Astro JSX parsing
const healthExample = `$ curl http://localhost:8000/health

{
  "status": "healthy",
  "triples": 39237,
  "store_type": "rdflib"
}`;

const sparqlRequest = `{
  "query": "SELECT ?s ?p ?o WHERE { ?s ?p ?o } LIMIT 10"
}`;

const sparqlExample = `$ curl -X POST http://localhost:8000/api/sparql \\
  -H "Content-Type: application/json" \\
  -d '{
    "query": "PREFIX bim: <http://example.org/bim-ontology/schema#> SELECT ?cat (COUNT(?e) AS ?num) WHERE { ?e rdf:type bim:PhysicalElement . ?e bim:hasCategory ?cat . } GROUP BY ?cat ORDER BY DESC(?num)"
  }'

{
  "results": [
    { "cat": "Pipe", "num": 823 },
    { "cat": "Equipment", "num": 456 }
  ],
  "count": 18,
  "cached": false
}`;

const reasoningExample = `$ curl -X POST http://localhost:8000/api/reasoning

{
  "total_triples": 65281,
  "total_inferred": 26044,
  "elapsed": 4.7,
  "rules_applied": [
    "infer_structural_element",
    "infer_mep_element",
    "infer_access_element",
    "infer_plant_support_element",
    "infer_piping_element",
    "infer_storey_has_elements",
    "infer_element_in_building"
  ]
}`;

const shaclExample = `$ curl -X POST http://localhost:8000/api/reasoning/validate

{
  "conforms": false,
  "violations_count": 12,
  "violations": [
    {
      "focus": "bim:element_001",
      "path": "bim:hasGlobalId",
      "message": "Missing required property",
      "severity": "Violation"
    }
  ]
}`;

const propExample = `$ curl http://localhost:8000/api/properties/3x4kBNM1v5fQ...

{
  "global_id": "3x4kBNM1v5fQ...",
  "element_name": "Pipe Segment 001",
  "property_sets": [
    {
      "name": "Pset_PipeSegmentCommon",
      "properties": {
        "NominalDiameter": 150.0,
        "OuterDiameter": 168.3,
        "WallThickness": 7.11
      }
    },
    {
      "name": "SP3D_PipeProperties",
      "properties": {
        "Weight": 23.4,
        "Material": "Carbon Steel",
        "InsulationType": "Hot"
      }
    }
  ]
}`;

const createTypeExample = `$ curl -X POST http://localhost:8000/api/ontology/types \\
  -H "Content-Type: application/json" \\
  -d '{
    "name": "HVACElement",
    "parent_class": "MEPElement",
    "label": "HVAC Element",
    "description": "Heating, ventilation, and air conditioning element"
  }'

{
  "name": "HVACElement",
  "parent_class": "MEPElement",
  "label": "HVAC Element",
  "description": "Heating, ventilation..."
}`;

const updateRulesExample = `$ curl -X PUT http://localhost:8000/api/ontology/rules \\
  -H "Content-Type: application/json" \\
  -d '{
    "rules": {
      "MemberSystem": ["membersystem"],
      "Hanger": ["hanger", "clamp"],
      "PipeFitting": ["pipe.*fitting", "elbow"]
    }
  }'

{
  "updated": true,
  "rule_count": 29
}`;

const createLinkExample = `$ curl -X POST http://localhost:8000/api/ontology/links \\
  -H "Content-Type: application/json" \\
  -d '{
    "name": "connectedTo",
    "domain": "PipingElement",
    "range_class": "PipingElement",
    "inverse_name": "connectedFrom"
  }'

{
  "name": "connectedTo",
  "domain": "PipingElement",
  "range_class": "PipingElement",
  "inverse_name": "connectedFrom"
}`;

const pythonClient = `from src.clients.python import BIMOntologyClient

# Local mode (IFC 파일 직접 로딩)
client = BIMOntologyClient.from_ifc("references/sample.ifc")

# Remote mode (API 서버 연결)
client = BIMOntologyClient.from_api("http://localhost:8000")

# Statistics
stats = client.get_statistics()
print(f"Triples: {stats['total_triples']}")

# Elements
pipes = client.get_elements(category="Pipe", limit=10)
for p in pipes:
    print(f"  {p['name']} - {p['global_id']}")

# Building hierarchy
hierarchy = client.get_hierarchy()

# SPARQL query
results = client.query("""
    PREFIX bim: <http://example.org/bim-ontology/schema#>
    SELECT ?cat (COUNT(?e) AS ?num)
    WHERE { ?e bim:hasCategory ?cat }
    GROUP BY ?cat ORDER BY DESC(?num)
""")`;
---

<Layout title="API Reference - BIM Ontology" description="BIM Ontology REST API & SPARQL Endpoint Reference">
  <section class="section" style="padding-top:48px;">
    <div class="container">
      <div style="margin-bottom:40px;">
        <a href={base} style="font-size:0.8rem;color:var(--text-muted);">&larr; Back to Home</a>
        <h1 style="font-size:2.2rem;font-weight:800;margin-top:12px;">API Reference</h1>
        <p style="color:var(--text-muted);font-size:1rem;margin-top:8px;">
          FastAPI 기반 20+ REST 엔드포인트. Base URL: <code>http://localhost:8000</code>
        </p>
      </div>

      <!-- TOC -->
      <div class="card" style="margin-bottom:48px;">
        <div class="card-header">Endpoint Groups</div>
        <div class="card-body">
          <div class="grid-3" style="gap:12px;">
            <a href="#core" style="text-decoration:none;">
              <div style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                <span class="badge badge-blue" style="margin-bottom:6px;">Core</span>
                <div style="font-size:0.85rem;">Health, Statistics, Buildings, Elements</div>
              </div>
            </a>
            <a href="#sparql" style="text-decoration:none;">
              <div style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                <span class="badge badge-purple" style="margin-bottom:6px;">SPARQL</span>
                <div style="font-size:0.85rem;">Query execution endpoint</div>
              </div>
            </a>
            <a href="#reasoning" style="text-decoration:none;">
              <div style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                <span class="badge badge-green" style="margin-bottom:6px;">Reasoning</span>
                <div style="font-size:0.85rem;">OWL inference & SHACL</div>
              </div>
            </a>
            <a href="#properties" style="text-decoration:none;">
              <div style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                <span class="badge badge-amber" style="margin-bottom:6px;">Properties</span>
                <div style="font-size:0.85rem;">Element properties & SP3D</div>
              </div>
            </a>
            <a href="#ontology" style="text-decoration:none;">
              <div style="padding:12px;border:1px solid var(--border);border-radius:8px;">
                <span class="badge badge-red" style="margin-bottom:6px;">Ontology</span>
                <div style="font-size:0.85rem;">Schema CRUD & rules</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Core API -->
      <div id="core" style="margin-bottom:48px;">
        <h2 class="section-title">Core API</h2>
        <p class="section-subtitle">기본 데이터 조회 엔드포인트</p>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr>
                  <th style="width:80px;">Method</th>
                  <th style="width:260px;">Path</th>
                  <th>Description</th>
                  <th style="width:120px;">Response</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/</code></td>
                  <td>Web Dashboard (HTML)</td>
                  <td style="color:var(--text-dim);">HTML</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/health</code></td>
                  <td>Health check - 서버 상태 및 트리플 수</td>
                  <td style="color:var(--text-dim);">JSON</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/statistics</code></td>
                  <td>전체 통계 (triples, elements, buildings, categories)</td>
                  <td style="color:var(--text-dim);">JSON</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/statistics/categories</code></td>
                  <td>카테고리별 요소 수 (정렬)</td>
                  <td style="color:var(--text-dim);">JSON[]</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/buildings</code></td>
                  <td>Building 목록</td>
                  <td style="color:var(--text-dim);">JSON[]</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/storeys</code></td>
                  <td>Building Storey 목록 (elevation 포함)</td>
                  <td style="color:var(--text-dim);">JSON[]</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/elements</code></td>
                  <td>Physical Element 목록</td>
                  <td style="color:var(--text-dim);">JSON[]</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/hierarchy</code></td>
                  <td>Building hierarchy (트리 구조)</td>
                  <td style="color:var(--text-dim);">JSON</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">GET /api/elements - Query Parameters</div>
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th>Parameter</th><th>Type</th><th>Default</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>category</code></td><td>string</td><td>-</td>
                  <td>카테고리 필터 (예: Pipe, Beam, Hanger)</td>
                </tr>
                <tr>
                  <td><code>limit</code></td><td>int</td><td>50</td>
                  <td>결과 수 제한</td>
                </tr>
                <tr>
                  <td><code>offset</code></td><td>int</td><td>0</td>
                  <td>페이지네이션 오프셋</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">Example: GET /health</div>
          <div class="card-body">
            <pre><code set:text={healthExample} /></pre>
          </div>
        </div>
      </div>

      <!-- SPARQL -->
      <div id="sparql" style="margin-bottom:48px;">
        <h2 class="section-title">SPARQL Endpoint</h2>
        <p class="section-subtitle">임의의 SPARQL SELECT 쿼리 실행</p>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th style="width:80px;">Method</th><th style="width:260px;">Path</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/sparql</code></td>
                  <td>SPARQL 쿼리 실행</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">Request Body</div>
          <div class="card-body">
            <pre><code set:text={sparqlRequest} /></pre>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">Example: Category Statistics</div>
          <div class="card-body">
            <pre><code set:text={sparqlExample} /></pre>
          </div>
        </div>
      </div>

      <!-- Reasoning -->
      <div id="reasoning" style="margin-bottom:48px;">
        <h2 class="section-title">Reasoning & Validation</h2>
        <p class="section-subtitle">OWL/RDFS 추론 및 SHACL 형상 검증</p>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th style="width:80px;">Method</th><th style="width:260px;">Path</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/reasoning</code></td>
                  <td>OWL/RDFS 추론 실행 (owlrl + 7개 커스텀 규칙)</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/reasoning/validate</code></td>
                  <td>SHACL Shape 검증 실행</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid-2" style="margin-top:16px;">
          <div class="card">
            <div class="card-header">Example: Run Reasoning</div>
            <div class="card-body">
              <pre><code set:text={reasoningExample} /></pre>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Example: SHACL Validation</div>
            <div class="card-body">
              <pre><code set:text={shaclExample} /></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Properties -->
      <div id="properties" style="margin-bottom:48px;">
        <h2 class="section-title">Properties API</h2>
        <p class="section-subtitle">요소 속성 조회 및 Smart3D Plant 데이터</p>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th style="width:80px;">Method</th><th style="width:300px;">Path</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/properties/:global_id</code></td>
                  <td>특정 요소의 전체 PropertySet 조회</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/properties/plant-data</code></td>
                  <td>Smart3D Plant(SP3D) 데이터 요약</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/properties/search</code></td>
                  <td>속성 키 기반 검색</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">GET /api/properties/search - Query Parameters</div>
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th>Parameter</th><th>Type</th><th>Default</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>key</code></td><td>string</td><td>required</td>
                  <td>검색할 속성 키 (예: Weight, Material)</td>
                </tr>
                <tr>
                  <td><code>limit</code></td><td>int</td><td>50</td>
                  <td>결과 수 제한</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">Example: Property Lookup</div>
          <div class="card-body">
            <pre><code set:text={propExample} /></pre>
          </div>
        </div>
      </div>

      <!-- Ontology Editor -->
      <div id="ontology" style="margin-bottom:48px;">
        <h2 class="section-title">Ontology Editor API</h2>
        <p class="section-subtitle">동적 스키마 CRUD - Object Types, Property Types, Link Types, Classification Rules</p>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr><th style="width:80px;">Method</th><th style="width:300px;">Path</th><th>Description</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/ontology/types</code></td>
                  <td>Object Type(OWL Class) 목록</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/ontology/types</code></td>
                  <td>새 Object Type 생성</td>
                </tr>
                <tr>
                  <td><span class="badge badge-amber">PUT</span></td>
                  <td><code>/api/ontology/types/:name</code></td>
                  <td>Object Type 수정</td>
                </tr>
                <tr>
                  <td><span class="badge badge-red">DELETE</span></td>
                  <td><code>/api/ontology/types/:name</code></td>
                  <td>Object Type 삭제</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/ontology/properties</code></td>
                  <td>Property Type 목록</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/ontology/properties</code></td>
                  <td>새 Property Type 생성</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/ontology/links</code></td>
                  <td>Link Type(OWL ObjectProperty) 목록</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/ontology/links</code></td>
                  <td>새 Link Type 생성</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/ontology/rules</code></td>
                  <td>분류 규칙 조회</td>
                </tr>
                <tr>
                  <td><span class="badge badge-amber">PUT</span></td>
                  <td><code>/api/ontology/rules</code></td>
                  <td>분류 규칙 수정</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/ontology/apply</code></td>
                  <td>커스텀 스키마를 RDF 그래프에 적용</td>
                </tr>
                <tr>
                  <td><span class="badge badge-green">GET</span></td>
                  <td><code>/api/ontology/export</code></td>
                  <td>스키마 JSON 내보내기</td>
                </tr>
                <tr>
                  <td><span class="badge badge-blue">POST</span></td>
                  <td><code>/api/ontology/import</code></td>
                  <td>스키마 JSON 가져오기</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid-2" style="margin-top:16px;">
          <div class="card">
            <div class="card-header">Example: Create Object Type</div>
            <div class="card-body">
              <pre><code set:text={createTypeExample} /></pre>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Example: Update Classification Rules</div>
            <div class="card-body">
              <pre><code set:text={updateRulesExample} /></pre>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">Example: Create Link Type</div>
          <div class="card-body">
            <pre><code set:text={createLinkExample} /></pre>
          </div>
        </div>
      </div>

      <!-- Python Client -->
      <div style="margin-bottom:48px;">
        <h2 class="section-title">Python Client</h2>
        <p class="section-subtitle">로컬/원격 모드를 지원하는 Python 클라이언트 라이브러리</p>
        <div class="card">
          <div class="card-body">
            <pre><code set:text={pythonClient} /></pre>
          </div>
        </div>
      </div>

    </div>
  </section>
</Layout>
